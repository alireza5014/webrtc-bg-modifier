class t{constructor({chatAgent:t=null}){console.log(t,"chatAgent2"),this.scriptLoaded=!1,this.segmentation=null,this.bgUrl=null,this.backgroundImage=null,this.color=null,this.chatAgent=t,this.stream=null,this.processing=!1,this.brightness=1,this.contrast=1,this.grayScale=!1,this.blur=0,this.fps=24,this.ctx=null,this.isMobile=/Mobi|Android/i.test(navigator.userAgent),this.videoInfo={videoWidth:640,videoHeight:480},this.videoElement=document.createElement("video"),this.canvasElement=document.createElement("canvas"),this.reaction=[],this.lastPushTime=0}drawReaction(){this.reaction&&this.reaction.map(t=>{this.ctx.globalCompositeOperation="source-over";const e=performance.now(),i=e-t.startTime;if(i>t.duration)return void(t=null);const s=i/t.duration;this.ctx.globalAlpha=1-s;const a=300*s,o=5*Math.sin(e/100),n=t.x+o,r=t.y-a;this.ctx.font="88px Arial",this.ctx.fillText(t.emoji,n,r),this.ctx.globalAlpha=1})}async setupSegmentation(){var t=this;const e=this.getBackgroundImage();await this.appendScriptToHead("https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js",{async:!0,callback:async function(){if(!t.segmentation){t.segmentation=new SelfieSegmentation({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${t}`}),t.videoElement.width=t.isMobile?480:1280,t.videoElement.height=t.isMobile?360:720,t.segmentation.setOptions({modelSelection:1,outputStride:16,segmentBody:!0,selfieMode:!1}),t.segmentation.onResults(i=>{console.log(i),t.color?(t.applyBackgroundColor(i),t.applyBrightnessAndContrast()):t.applyBackgroundImage(i,e),t.applyGrayscale()});let i=0;const s=async function e(){if(t.processing){const e=performance.now();e-i>=1e3/t.fps&&(i=e,await t.segmentation.send({image:t.videoElement}))}requestAnimationFrame(e)};await s()}}})}setBackgroundImage2(t){return this.backgroundImage=t,this}async appendScriptToHead(t,{async:e=!0,defer:i=!1,callback:s=()=>{}}={}){var a=this;if(this.scriptLoaded)return void await s();const o=document.createElement("script");o.src=t,o.async=e,o.defer=i,o.onload=async function(){a.scriptLoaded=!0,await s()},o.onerror=()=>console.error(`Failed to load script: ${t}`),document.head.appendChild(o)}applyBackgroundImage(t){const{videoWidth:e,videoHeight:i}=this.videoInfo;t.segmentationMask&&(this.getBackgroundImage()||this.videoElement)&&(this.ctx.drawImage(t.segmentationMask,0,0,e,i),this.ctx.globalCompositeOperation="source-out",this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast}) blur(${this.blur})`,this.ctx.drawImage(this.getBackgroundImage()?this.getBackgroundImage():this.videoElement,0,0,e,i),this.drawReaction(),this.ctx.globalCompositeOperation="destination-atop",this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast})`,this.ctx.drawImage(t.image,0,0,e,i))}applyBrightnessAndContrast(){this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast}) `}applyBackgroundColor(t){const{videoWidth:e,videoHeight:i}=this.videoInfo;this.ctx.drawImage(t.segmentationMask,0,0,e,i),this.ctx.globalCompositeOperation="source-out",this.color!==this.ctx.fillStyle&&(this.ctx.fillStyle=this.color),this.ctx.fillRect(0,0,e,i),this.drawReaction(),this.ctx.globalCompositeOperation="destination-atop",this.ctx.drawImage(t.image,0,0,e,i)}applyGrayscale(){if(this.grayScale){const{videoWidth:t,videoHeight:e}=this.videoInfo,i=this.ctx.getImageData(0,0,t,e),s=i.data;for(let t=0;t<s.length;t+=4)s[t]=s[t+1]=s[t+2]=(s[t]+s[t+1]+s[t+2])/3;this.ctx.putImageData(i,0,0)}}addReaction(t,e=0,i=0,s=2e3){if(this.segmentation){const a=performance.now();a-this.lastPushTime>=1e3?(this.reaction.push({emoji:t,x:e,y:i,startTime:performance.now(),duration:s}),this.lastPushTime=a):console.log("Waiting for 1 second to pass before adding another reaction.")}else console.error("Please use reaction after segmentation is available.");return this}setFps(t){return this.fps=t,this}getBackgroundImage(){return this.backgroundImage}setBrightness(t){return this.brightness=+t,this}setContrast(t){return this.contrast=+t,this}setBlur(t){return this.blur=+t+"px",this}setGrayScale(t){return this.grayScale=t,this}setStream(t){return this.stream=t,this}setBackgroundImage(t){return this.bgUrl=t,this.color=null,this}setBackgroundColor(t){return this.color=t,this.bgUrl=null,this}backgroundList(){return{reactions:[{value:"ðŸŽ‰"},{value:"â¤ï¸"},{value:"ðŸ‘ï¸"},{value:"ðŸ˜Š"},{value:"ðŸ˜Ž"},{value:"ðŸ‘Ž"}],color:[{value:"#f9c0ab",alt:"#F9C0AB"},{value:"#f4e0af",alt:"#F4E0AF"},{value:"#a8cd89",alt:"#A8CD89"},{value:"#355f2e",alt:"#355F2E"}],image:[{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/1.jpg",alt:"Image 1"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/2.jpg",alt:"Image 2"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/3.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/4.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/5.webp",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/6.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/7.webp",alt:"Image 113"}]}}async changeBackground(){this.chatAgent.deviceManager().grantUserMediaDevicesPermissions({video:{width:this.videoInfo.videoWidth,height:this.videoInfo.videoHeight,framerate:10}},t=>{if(console.log(t,"result"),this.stream=t.videoStream,!this.videoElement.srcObject){this.videoElement.srcObject=this.stream,this.videoElement.play(),this.videoElement.addEventListener("loadedmetadata",()=>{this.videoInfo={videoWidth:this.videoElement.videoWidth,videoHeight:this.videoElement.videoHeight}});const{videoWidth:t,videoHeight:e}=this.videoInfo;this.canvasElement.width=t,this.canvasElement.height=e,this.ctx=this.canvasElement.getContext("2d")}if(!(this.bgUrl||this.grayScale||1!==this.brightness||1!==this.contrast||this.color||this.blur))return this.processing=!1,this.chatAgent.replaceVideoStream(this.stream),this.stream;let e=null;this.bgUrl&&(e=new Image,e.crossOrigin="anonymous",e.src=this.bgUrl),this.processing=!0,this.setBackgroundImage2(e),this.setupSegmentation();const i=this.canvasElement.captureStream(this.fps);return this.chatAgent.replaceVideoStream(i),i})}async makePreview(){if(!this.videoElement.srcObject){this.videoElement.srcObject=this.stream,this.videoElement.play(),this.videoElement.addEventListener("loadedmetadata",()=>{this.videoInfo={videoWidth:this.videoElement.videoWidth,videoHeight:this.videoElement.videoHeight}});const{videoWidth:t,videoHeight:e}=this.videoInfo;this.canvasElement.width=t,this.canvasElement.height=e,this.ctx=this.canvasElement.getContext("2d")}if(!(this.bgUrl||this.grayScale||1!==this.brightness||1!==this.contrast||this.color||this.blur))return this.processing=!1,this.stream;let t=null;return this.bgUrl&&(t=new Image,t.crossOrigin="anonymous",t.src=this.bgUrl),this.processing=!0,this.setBackgroundImage2(t),this.setupSegmentation(),this.canvasElement.captureStream(this.fps)}}export{t as default};
//# sourceMappingURL=index.modern.mjs.map

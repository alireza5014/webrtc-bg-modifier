class e{constructor(){this.scriptLoaded=!1,this.segmentation=null,this.url=null,this.camera=null,this.backgroundImage=null,this.color=null,this.stream=null,this.processing=!1,this.brightness=1,this.contrast=1,this.grayScale=!1,this.blur=0,this.fps=24,this.videoInfo={videoWidth:640,videoHeight:480},this.videoElement=document.createElement("video"),this.canvasElement=document.createElement("canvas")}setFps(e){return this.fps=e,this}setBackgroundImage2(e){return this.backgroundImage=e,this}getBackgroundImage(){return this.backgroundImage}setBrightness(e){return this.brightness=+e,this}setContrast(e){return this.contrast=+e,this}setBlur(e){return this.blur=+e+"px",this}setGrayScale(e){return this.grayScale=e,this}setStream(e){return this.stream=e,this}setBackgroundImage(e){return this.url=e,this.color=null,this}setBackgroundColor(e){return this.color=e,this}async appendScriptToHead(e,{async:t=!0,defer:i=!1,callback:a=()=>{}}={}){var s=this;if(this.scriptLoaded)return void await a();const o=document.createElement("script");o.src=e,o.async=t,o.defer=i,o.onload=async function(){s.scriptLoaded=!0,await a()},o.onerror=()=>console.error(`Failed to load script: ${e}`),document.head.appendChild(o)}applyBackgroundImage(e,t){const{videoWidth:i,videoHeight:a}=this.videoInfo;e.clearRect(0,0,i,a),e.filter=`brightness(${this.brightness}) contrast(${this.contrast}) blur(${this.blur})`,e.drawImage(t.segmentationMask,0,0,i,a),e.globalCompositeOperation="source-out",e.drawImage(this.getBackgroundImage()?this.getBackgroundImage():this.videoElement,0,0,i,a),e.globalCompositeOperation="destination-atop",e.filter=`brightness(${this.brightness}) contrast(${this.contrast})`,e.drawImage(t.image,0,0,i,a)}applyBrightnessAndContrast(e){e.filter=`brightness(${this.brightness}) contrast(${this.contrast}) `}applyBackgroundColor(e,t){const{videoWidth:i,videoHeight:a}=this.videoInfo;e.clearRect(0,0,i,a),e.drawImage(t.segmentationMask,0,0,i,a),e.globalCompositeOperation="source-out",e.fillStyle=this.color,e.fillRect(0,0,i,a),e.globalCompositeOperation="destination-atop",e.drawImage(t.image,0,0,i,a)}applyGrayscale(e){const{videoWidth:t,videoHeight:i}=this.videoInfo,a=e.getImageData(0,0,t,i),s=a.data;for(let e=0;e<s.length;e+=4)s[e]=s[e+1]=s[e+2]=(s[e]+s[e+1]+s[e+2])/3;e.putImageData(a,0,0)}backgroundList(){return{color:[{value:"#F9C0AB",alt:"#F9C0AB"},{value:"#F4E0AF",alt:"#F4E0AF"},{value:"#A8CD89",alt:"#A8CD89"},{value:"#355F2E",alt:"#355F2E"}],image:[{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/1.jpg",alt:"Image 1"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/2.jpg",alt:"Image 2"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/3.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/4.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/5.webp",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/6.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/7.webp",alt:"Image 113"}]}}async setupSegmentation(e){var t=this;const i=this.getBackgroundImage();await this.appendScriptToHead("https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js",{async:!0,callback:async function(){if(!t.segmentation){t.segmentation=new SelfieSegmentation({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${e}`});const a=/Mobi|Android/i.test(navigator.userAgent);t.videoElement.width=a?480:1280,t.videoElement.height=a?360:720,t.segmentation.setOptions({selfieMode:!1,modelSelection:a?0:1}),t.segmentation.onResults(a=>{t.color?(t.applyBackgroundColor(e,a),t.applyBrightnessAndContrast(e)):t.applyBackgroundImage(e,a,i),t.grayScale&&t.applyGrayscale(e)});let s=0;const o=async function e(){if(t.processing){const e=performance.now();e-s>=1e3/t.fps&&(s=e,await t.segmentation.send({image:t.videoElement}))}requestAnimationFrame(e)};await o()}}})}async changeBackground(){this.videoElement.srcObject||(this.videoElement.srcObject=this.stream,this.videoElement.play(),await new Promise(e=>this.videoElement.onloadeddata=e),this.videoElement.addEventListener("loadedmetadata",()=>{console.log({videoWidth:this.videoElement.videoWidth,videoHeight:this.videoElement.videoHeight},"jjjjjjjj"),this.videoInfo={videoWidth:this.videoElement.videoWidth,videoHeight:this.videoElement.videoHeight}}));const{videoWidth:e,videoHeight:t}=this.videoInfo;this.canvasElement.width=e,this.canvasElement.height=t;const i=this.canvasElement.getContext("2d");if(!(this.url||this.grayScale||1!==this.brightness||1!==this.contrast||this.color||this.blur))return this.processing=!1,this.stream;let a=null;return this.url&&(a=new Image,a.crossOrigin="anonymous",a.src=this.url,await new Promise(e=>a.onload=e)),this.processing=!0,this.setBackgroundImage2(a),await this.setupSegmentation(i),this.canvasElement.captureStream(this.fps)}}export{e as default};
//# sourceMappingURL=index.modern.js.map

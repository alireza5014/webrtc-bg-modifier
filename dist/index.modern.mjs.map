{"version":3,"file":"index.modern.mjs","sources":["../src/index.js"],"sourcesContent":["class WebrtcBgModifier {\n    constructor() {\n        this.scriptLoaded = false;\n        this.segmentation = null;\n        this.url = null;\n        this.camera = null;\n        this.backgroundImage = null;\n        this.color = null;\n        this.stream = null;\n        this.brightness = 1;\n        this.contrast = 1;\n        this.grayScale = false;\n        this.blur = 0;\n        this.videoElement = document.createElement(\"video\");\n        this.canvasElement = document.createElement(\"canvas\");\n    }\n\n    // Setters for background properties\n    setBackgroundImage2(value) {\n        this.backgroundImage = value;\n        return this;\n    }\n\n    getBackgroundImage() {\n        return  this.backgroundImage\n     }\n    setBrightness(value) {\n        this.brightness = +value;\n        return this;\n    }\n\n    setContrast(value) {\n        this.contrast = +value;\n        return this;\n    }\n    setBlur(value) {\n        this.blur = +value+\"px\";\n        return this;\n    }\n\n    setGrayScale(value) {\n        this.grayScale = value;\n        return this;\n    }\n\n    setStream(stream) {\n        this.stream = stream;\n        return this;\n    }\n\n    setBackgroundImage(url) {\n        this.url = url;\n        this.color = null;\n        return this;\n    }\n\n    setBackgroundColor(color) {\n        this.color = color;\n\n        return this;\n    }\n\n    // Appends a script to the document head, ensuring it loads only once\n    async appendScriptToHead(src, {\n        async = true, defer = false, callback = () => {\n        }\n    } = {}) {\n        if (this.scriptLoaded) {\n            await  callback();\n            return;\n        }\n\n        const script = document.createElement('script');\n        script.src = src;\n        script.async = async;\n        script.defer = defer;\n        script.onload =async () => {\n            this.scriptLoaded = true;\n          await  callback();\n        };\n        script.onerror = () => console.error(`Failed to load script: ${src}`);\n        document.head.appendChild(script);\n    }\n\n    // Handles background image replacement logic\n    applyBackgroundImage(ctx, results) {\n        // const {videoWidth: width, videoHeight: height} = this.videoElement;\n        const  width=480\n        const  height=360\n        ctx.clearRect(0, 0, width, height);\n        ctx.filter = `brightness(${this.brightness}) contrast(${this.contrast}) blur(${this.blur})`;\n\n        ctx.drawImage(results.segmentationMask, 0, 0, width, height);\n        ctx.globalCompositeOperation = 'source-out';\n\n        ctx.drawImage(this.getBackgroundImage() ? this.getBackgroundImage() : this.videoElement, 0, 0, width, height);\n        ctx.globalCompositeOperation = 'destination-atop';\n\n        ctx.filter = `brightness(${this.brightness}) contrast(${this.contrast})`\n        ctx.drawImage(results.image, 0, 0, width, height);\n\n    }\n\n    // Adjusts brightness and contrast for the video\n    applyBrightnessAndContrast(ctx) {\n        ctx.filter = `brightness(${this.brightness}) contrast(${this.contrast}) `;\n    }\n\n    // Applies a solid background color\n    applyBackgroundColor(ctx, results) {\n        // const {videoWidth: width, videoHeight: height} = this.videoElement;\n     const  width=480\n        const  height=360\n        ctx.clearRect(0, 0, width, height);\n        ctx.drawImage(results.segmentationMask, 0, 0, width, height);\n        ctx.globalCompositeOperation = 'source-out';\n        ctx.fillStyle = this.color;\n        ctx.fillRect(0, 0, width, height);\n        ctx.globalCompositeOperation = 'destination-atop';\n        ctx.drawImage(results.image, 0, 0, width, height);\n    }\n\n\n    // Applies a grayscale effect\n    applyGrayscale(ctx) {\n        const {videoWidth: width, videoHeight: height} = this.videoElement;\n        const imageData = ctx.getImageData(0, 0, width, height);\n        const data = imageData.data;\n\n        for (let i = 0; i < data.length; i += 4) {\n            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;\n            data[i] = data[i + 1] = data[i + 2] = avg;\n        }\n\n        ctx.putImageData(imageData, 0, 0);\n    }\n\n    // Generates a list of available backgrounds\n    backgroundList() {\n        return {\n            color: [\n                {value: '#F9C0AB', alt: '#F9C0AB'},\n                {value: '#F4E0AF', alt: '#F4E0AF'},\n                {value: '#A8CD89', alt: '#A8CD89'},\n                {value: '#355F2E', alt: '#355F2E'},\n            ],\n            image: [\n                {value: 'img/1.jpg', alt: 'Image 1'},\n                {value: 'img/2.jpg', alt: 'Image 2'},\n                {value: 'img/3.jpg', alt: 'Image 3'},\n            ],\n        };\n    }\n\n    // Initializes the segmentation process\n    async setupSegmentation(ctx) {\n       const backgroundImage= this.getBackgroundImage()\n        await this.appendScriptToHead('https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js', {\n            async: true,\n            callback: async () => {\n                if (!this.segmentation) {\n                    this.segmentation = new SelfieSegmentation({\n                        // locateFile: (file) => `/node_modules/@mediapipe/selfie_segmentation/${file}`,\n                        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`,\n                    });\n                    const isMobile = /Mobi|Android/i.test(navigator.userAgent);\n\n                    alert(navigator.hardwareConcurrency)\n\n                    if (navigator.hardwareConcurrency < 4) {\n                         // Reduce segmentation resolution or frame rate for low-end devices\n                    }\n                    if (isMobile) {\n\n                        this.videoElement.width = 480;\n                        this.videoElement.height = 360;\n                    } else {\n\n\n                        this.videoElement.width = 1280;\n                        this.videoElement.height = 720;\n                    }\n                    this.segmentation.setOptions({\n                        modelSelection: isMobile?0:1, // Full model for desktops\n                    });\n\n                    // this.segmentation.setOptions({\n                    //     selfieMode: true,\n                    //     modelSelection: 0,\n                    //\n                    //     // effect: \"background\"\n                    // });\n\n                    this.segmentation.onResults((results) => {\n                        console.log(results)\n                        if (this.color) {\n                            this.applyBackgroundColor(ctx, results);\n                            this.applyBrightnessAndContrast(ctx);\n                        } else {\n                            this.applyBackgroundImage(ctx, results, backgroundImage);\n\n                        }\n\n                        if (this.grayScale) {\n                            this.applyGrayscale(ctx);\n                        }\n                        // this.applyBrightnessAndContrast(ctx);\n                    });\n\n\n\n\n                    const targetFPS = 12;\n                    let lastFrameTime = 0;\n\n                    const processVideo = async () => {\n                        const now = performance.now();\n                        if (now - lastFrameTime >= 1000 / targetFPS) {\n                            lastFrameTime = now;\n                            await this.segmentation.send({ image: this.videoElement });\n                        }\n\n                        requestAnimationFrame(processVideo);\n                    };\n\n                    await processVideo();\n\n\n\n                    // await this.segmentation.initialize();\n                    //\n                    // const processVideo = async () => {\n                    //     await this.segmentation.send({image: this.videoElement});\n                    //     requestAnimationFrame(processVideo);\n                    // };\n                    //\n                    // await processVideo();\n                }\n                // if (!this.camera) {\n                //     this.camera = new Camera(this.videoElement, {\n                //         onFrame: async () => {\n                //             await this.segmentation.send({ image: this.videoElement });\n                //         },\n                //         width: 1280,\n                //         height: 720,\n                //     });\n                // }\n                //\n                // this.camera.start();\n            },\n        });\n    }\n\n    // Main function to modify the video stream\n    async changeBackground() {\n\n        console.log(  this.url,'11111')\n        if(!this.videoElement.srcObject) {\n            this.videoElement.srcObject = this.stream;\n            this.videoElement.play();\n            await new Promise((resolve) => (this.videoElement.onloadeddata = resolve));\n\n        }\n\n\n        const {videoWidth: width, videoHeight: height} = this.videoElement;\n        this.canvasElement.width = width;\n        this.canvasElement.height = height;\n        const ctx = this.canvasElement.getContext('2d');\n\n        if (!this.url && !this.grayScale && this.brightness === 1 && this.contrast === 1 && !this.color && !this.blur) {\n\n                this.camera?.stop()\n\n            return this.stream; // No modifications, return original stream\n        }\n\n        let backgroundImage = null;\n        if (this.url) {\n              backgroundImage = new Image();\n            backgroundImage.src = this.url;\n             await new Promise((resolve) => (backgroundImage.onload = resolve));\n            this.setBackgroundImage2(backgroundImage)\n\n        }\n        this.setBackgroundImage2(backgroundImage)\n        await this.setupSegmentation(ctx);\n        return  this.canvasElement.captureStream(24);\n    }\n}\n\nexport default WebrtcBgModifier;"],"names":["WebrtcBgModifier","constructor","this","scriptLoaded","segmentation","url","camera","backgroundImage","color","stream","brightness","contrast","grayScale","blur","videoElement","document","createElement","canvasElement","setBackgroundImage2","value","getBackgroundImage","setBrightness","setContrast","setBlur","setGrayScale","setStream","setBackgroundImage","setBackgroundColor","appendScriptToHead","src","async","defer","callback","_this","script","onload","onerror","console","error","head","appendChild","applyBackgroundImage","ctx","results","width","height","clearRect","filter","drawImage","segmentationMask","globalCompositeOperation","image","applyBrightnessAndContrast","applyBackgroundColor","fillStyle","fillRect","applyGrayscale","videoWidth","videoHeight","imageData","getImageData","data","i","length","putImageData","backgroundList","alt","setupSegmentation","_this2","SelfieSegmentation","locateFile","file","isMobile","test","navigator","userAgent","alert","hardwareConcurrency","setOptions","modelSelection","onResults","log","targetFPS","lastFrameTime","processVideo","now","performance","send","requestAnimationFrame","changeBackground","srcObject","play","Promise","resolve","onloadeddata","getContext","_this$camera","stop","Image","captureStream"],"mappings":"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"}
module.exports=class{constructor({chatAgent:e=null}){console.log(e,"chatAgent2"),this.scriptLoaded=!1,this.segmentation=null,this.bgUrl=null,this.backgroundImage=null,this.color=null,this.chatAgent=e,this.stream=null,this.processing=!1,this.brightness=1,this.contrast=1,this.grayScale=!1,this.blur=0,this.fps=24,this.ctx=null,this.isMobile=/Mobi|Android/i.test(navigator.userAgent),this.videoInfo={videoWidth:640,videoHeight:480},this.videoElement=document.createElement("video"),this.canvasElement=document.createElement("canvas"),this.reaction=[],this.lastPushTime=0}drawReaction(){this.reaction&&this.reaction.map(e=>{this.ctx.globalCompositeOperation="source-over";const t=performance.now(),i=t-e.startTime;if(i>e.duration)return void(e=null);const o=i/e.duration;this.ctx.globalAlpha=1-o;const n=300*o,s=5*Math.sin(t/100),r=e.x+s,a=e.y-n;this.ctx.font="88px Arial",this.ctx.fillText(e.emoji,r,a),this.ctx.globalAlpha=1})}setupSegmentation(){try{const e=this,t=e.getBackgroundImage();return Promise.resolve(e.appendScriptToHead("https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js",{async:!0,callback:function(){try{const i=function(){if(!e.segmentation){e.segmentation=new SelfieSegmentation({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${e}`}),e.videoElement.width=e.isMobile?480:1280,e.videoElement.height=e.isMobile?360:720,e.segmentation.setOptions({modelSelection:1,outputStride:16,segmentBody:!0,selfieMode:!1}),e.segmentation.onResults(i=>{console.log(i),e.color?(e.applyBackgroundColor(i),e.applyBrightnessAndContrast()):e.applyBackgroundImage(i,t),e.applyGrayscale()});let i=0;const o=function(){try{function t(){requestAnimationFrame(o)}const n=function(){if(e.processing){const t=performance.now(),o=function(){if(t-i>=1e3/e.fps)return i=t,Promise.resolve(e.segmentation.send({image:e.videoElement})).then(function(){})}();if(o&&o.then)return o.then(function(){})}}();return Promise.resolve(n&&n.then?n.then(t):t())}catch(s){return Promise.reject(s)}};return Promise.resolve(o()).then(function(){})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}})).then(function(){})}catch(e){return Promise.reject(e)}}setBackgroundImage2(e){return this.backgroundImage=e,this}appendScriptToHead(e,{async:t=!0,defer:i=!1,callback:o=()=>{}}={}){try{let n;const s=this;function r(r){if(n)return r;const a=document.createElement("script");a.src=e,a.async=t,a.defer=i,a.onload=function(){try{return s.scriptLoaded=!0,Promise.resolve(o()).then(function(){})}catch(e){return Promise.reject(e)}},a.onerror=()=>console.error(`Failed to load script: ${e}`),document.head.appendChild(a)}const a=function(){if(s.scriptLoaded)return Promise.resolve(o()).then(function(){n=1})}();return Promise.resolve(a&&a.then?a.then(r):r(a))}catch(l){return Promise.reject(l)}}applyBackgroundImage(e){const{videoWidth:t,videoHeight:i}=this.videoInfo;e.segmentationMask&&(this.getBackgroundImage()||this.videoElement)&&(this.ctx.drawImage(e.segmentationMask,0,0,t,i),this.ctx.globalCompositeOperation="source-out",this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast}) blur(${this.blur})`,this.ctx.drawImage(this.getBackgroundImage()?this.getBackgroundImage():this.videoElement,0,0,t,i),this.drawReaction(),this.ctx.globalCompositeOperation="destination-atop",this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast})`,this.ctx.drawImage(e.image,0,0,t,i))}applyBrightnessAndContrast(){this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast}) `}applyBackgroundColor(e){const{videoWidth:t,videoHeight:i}=this.videoInfo;this.ctx.drawImage(e.segmentationMask,0,0,t,i),this.ctx.globalCompositeOperation="source-out",this.color!==this.ctx.fillStyle&&(this.ctx.fillStyle=this.color),this.ctx.fillRect(0,0,t,i),this.drawReaction(),this.ctx.globalCompositeOperation="destination-atop",this.ctx.drawImage(e.image,0,0,t,i)}applyGrayscale(){if(this.grayScale){const{videoWidth:e,videoHeight:t}=this.videoInfo,i=this.ctx.getImageData(0,0,e,t),o=i.data;for(let e=0;e<o.length;e+=4)o[e]=o[e+1]=o[e+2]=(o[e]+o[e+1]+o[e+2])/3;this.ctx.putImageData(i,0,0)}}addReaction(e,t=0,i=0,o=2e3){if(this.segmentation){const n=performance.now();n-this.lastPushTime>=1e3?(this.reaction.push({emoji:e,x:t,y:i,startTime:performance.now(),duration:o}),this.lastPushTime=n):console.log("Waiting for 1 second to pass before adding another reaction.")}else console.error("Please use reaction after segmentation is available.");return this}setFps(e){return this.fps=e,this}getBackgroundImage(){return this.backgroundImage}setBrightness(e){return this.brightness=+e,this}setContrast(e){return this.contrast=+e,this}setBlur(e){return this.blur=+e+"px",this}setGrayScale(e){return this.grayScale=e,this}setStream(e){return this.stream=e,this}setBackgroundImage(e){return this.bgUrl=e,this.color=null,this}setBackgroundColor(e){return this.color=e,this.bgUrl=null,this}backgroundList(){return{reactions:[{value:"ðŸŽ‰"},{value:"â¤ï¸"},{value:"ðŸ‘ï¸"},{value:"ðŸ˜Š"},{value:"ðŸ˜Ž"},{value:"ðŸ‘Ž"}],color:[{value:"#f9c0ab",alt:"#F9C0AB"},{value:"#f4e0af",alt:"#F4E0AF"},{value:"#a8cd89",alt:"#A8CD89"},{value:"#355f2e",alt:"#355F2E"}],image:[{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/1.jpg",alt:"Image 1"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/2.jpg",alt:"Image 2"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/3.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/4.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/5.webp",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/6.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/7.webp",alt:"Image 113"}]}}changeBackground(){try{const e=this;return e.chatAgent.deviceManager().grantUserMediaDevicesPermissions({video:{width:e.videoInfo.videoWidth,height:e.videoInfo.videoHeight,framerate:10}},t=>{if(console.log(t,"result"),e.stream=t.videoStream,!e.videoElement.srcObject){e.videoElement.srcObject=e.stream,e.videoElement.play(),e.videoElement.addEventListener("loadedmetadata",()=>{e.videoInfo={videoWidth:e.videoElement.videoWidth,videoHeight:e.videoElement.videoHeight}});const{videoWidth:t,videoHeight:i}=e.videoInfo;e.canvasElement.width=t,e.canvasElement.height=i,e.ctx=e.canvasElement.getContext("2d")}if(!(e.bgUrl||e.grayScale||1!==e.brightness||1!==e.contrast||e.color||e.blur))return e.processing=!1,e.chatAgent.replaceVideoStream(e.stream),e.stream;let i=null;e.bgUrl&&(i=new Image,i.crossOrigin="anonymous",i.src=e.bgUrl),e.processing=!0,e.setBackgroundImage2(i),e.setupSegmentation();const o=e.canvasElement.captureStream(e.fps);return e.chatAgent.replaceVideoStream(o),o}),Promise.resolve()}catch(e){return Promise.reject(e)}}makePreview(){try{const e=this;if(!e.videoElement.srcObject){e.videoElement.srcObject=e.stream,e.videoElement.play(),e.videoElement.addEventListener("loadedmetadata",()=>{e.videoInfo={videoWidth:e.videoElement.videoWidth,videoHeight:e.videoElement.videoHeight}});const{videoWidth:t,videoHeight:i}=e.videoInfo;e.canvasElement.width=t,e.canvasElement.height=i,e.ctx=e.canvasElement.getContext("2d")}if(!(e.bgUrl||e.grayScale||1!==e.brightness||1!==e.contrast||e.color||e.blur))return e.processing=!1,Promise.resolve(e.stream);let t=null;e.bgUrl&&(t=new Image,t.crossOrigin="anonymous",t.src=e.bgUrl),e.processing=!0,e.setBackgroundImage2(t),e.setupSegmentation();const i=e.canvasElement.captureStream(e.fps);return Promise.resolve(i)}catch(e){return Promise.reject(e)}}};
//# sourceMappingURL=index.js.map

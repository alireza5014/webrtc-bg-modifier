module.exports=class{constructor(){this.scriptLoaded=!1,this.segmentation=null,this.url=null,this.camera=null,this.backgroundImage=null,this.color=null,this.stream=null,this.processing=!1,this.brightness=1,this.contrast=1,this.grayScale=!1,this.blur=0,this.fps=24,this.ctx=null,this.videoInfo={videoWidth:100,videoHeight:100},this.videoElement=document.createElement("video"),this.canvasElement=document.createElement("canvas")}setFps(t){return this.fps=t,this}setBackgroundImage2(t){return this.backgroundImage=t,this}getBackgroundImage(){return this.backgroundImage}setBrightness(t){return this.brightness=+t,this}setContrast(t){return this.contrast=+t,this}setBlur(t){return this.blur=+t+"px",this}setGrayScale(t){return this.grayScale=t,this}setStream(t){return this.stream=t,this}setBackgroundImage(t){return this.url=t,this.color=null,this}setBackgroundColor(t){return this.color=t,this}appendScriptToHead(t,{async:e=!0,defer:i=!1,callback:n=()=>{}}={}){try{let r;const s=this;function o(o){if(r)return o;const a=document.createElement("script");a.src=t,a.async=e,a.defer=i,a.onload=function(){try{return s.scriptLoaded=!0,Promise.resolve(n()).then(function(){})}catch(t){return Promise.reject(t)}},a.onerror=()=>console.error(`Failed to load script: ${t}`),document.head.appendChild(a)}const a=function(){if(s.scriptLoaded)return Promise.resolve(n()).then(function(){r=1})}();return Promise.resolve(a&&a.then?a.then(o):o(a))}catch(c){return Promise.reject(c)}}applyBackgroundImage(t){const{videoWidth:e,videoHeight:i}=this.videoInfo;this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast}) blur(${this.blur})`,this.ctx.drawImage(t.segmentationMask,0,0,e,i),this.ctx.globalCompositeOperation="source-out",this.ctx.drawImage(this.getBackgroundImage()?this.getBackgroundImage():this.videoElement,0,0,e,i),this.ctx.globalCompositeOperation="destination-atop",this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast})`,this.ctx.drawImage(t.image,0,0,e,i)}applyBrightnessAndContrast(){this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast}) `}applyBackgroundColor(t){const{videoWidth:e,videoHeight:i}=this.videoInfo;this.ctx.drawImage(t.segmentationMask,0,0,e,i),this.ctx.globalCompositeOperation="source-out",this.color!==this.ctx.fillStyle&&(this.ctx.fillStyle=this.color),this.ctx.fillRect(0,0,e,i),this.ctx.globalCompositeOperation="destination-atop",this.ctx.drawImage(t.image,0,0,e,i)}applyGrayscale(){const{videoWidth:t,videoHeight:e}=this.videoInfo,i=this.ctx.getImageData(0,0,t,e),n=i.data;for(let t=0;t<n.length;t+=4)n[t]=n[t+1]=n[t+2]=(n[t]+n[t+1]+n[t+2])/3;this.ctx.putImageData(i,0,0)}backgroundList(){return{color:[{value:"#f9c0ab",alt:"#F9C0AB"},{value:"#f4e0af",alt:"#F4E0AF"},{value:"#a8cd89",alt:"#A8CD89"},{value:"#355f2e",alt:"#355F2E"}],image:[{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/1.jpg",alt:"Image 1"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/2.jpg",alt:"Image 2"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/3.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/4.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/5.webp",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/6.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/7.webp",alt:"Image 113"}]}}setupSegmentation(t){try{const t=this,e=t.getBackgroundImage();return Promise.resolve(t.appendScriptToHead("https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js",{async:!0,callback:function(){try{const i=function(){if(!t.segmentation){t.segmentation=new SelfieSegmentation({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${t}`});const i=/Mobi|Android/i.test(navigator.userAgent);t.videoElement.width=i?480:1280,t.videoElement.height=i?360:720,t.segmentation.setOptions({selfieMode:!1,modelSelection:i?0:1}),t.segmentation.onResults(i=>{t.color?(t.applyBackgroundColor(i),t.applyBrightnessAndContrast()):t.applyBackgroundImage(i,e),t.grayScale&&t.applyGrayscale()});let n=0;const r=function(){try{function e(){requestAnimationFrame(r)}const i=function(){if(t.processing){const e=performance.now(),i=function(){if(e-n>=1e3/t.fps)return n=e,Promise.resolve(t.segmentation.send({image:t.videoElement})).then(function(){})}();if(i&&i.then)return i.then(function(){})}}();return Promise.resolve(i&&i.then?i.then(e):e())}catch(s){return Promise.reject(s)}};return Promise.resolve(r()).then(function(){})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}})).then(function(){})}catch(t){return Promise.reject(t)}}changeBackground(){try{const t=this;function e(){if(!(t.url||t.grayScale||1!==t.brightness||1!==t.contrast||t.color||t.blur))return t.processing=!1,t.stream;let e=null;return t.url&&(e=new Image,e.crossOrigin="anonymous",e.src=t.url),t.processing=!0,t.setBackgroundImage2(e),t.setupSegmentation(),t.canvasElement.captureStream(t.fps)}const i=function(){if(!t.videoElement.srcObject)return t.videoElement.srcObject=t.stream,Promise.resolve(t.videoElement.play()).then(function(){t.videoElement.addEventListener("loadedmetadata",()=>{});const{videoWidth:e,videoHeight:i}=t.videoInfo;t.canvasElement.width=e,t.canvasElement.height=i,t.ctx=t.canvasElement.getContext("2d")})}();return Promise.resolve(i&&i.then?i.then(e):e())}catch(n){return Promise.reject(n)}}};
//# sourceMappingURL=index.js.map

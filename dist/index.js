module.exports=class{constructor(){this.scriptLoaded=!1,this.segmentation=null,this.url=null,this.camera=null,this.backgroundImage=null,this.color=null,this.stream=null,this.processing=!1,this.brightness=1,this.contrast=1,this.grayScale=!1,this.blur=0,this.fps=24,this.ctx=null,this.videoInfo={videoWidth:640,videoHeight:480},this.videoElement=document.createElement("video"),this.canvasElement=document.createElement("canvas")}setFps(e){return this.fps=e,this}setBackgroundImage2(e){return this.backgroundImage=e,this}getBackgroundImage(){return this.backgroundImage}setBrightness(e){return this.brightness=+e,this}setContrast(e){return this.contrast=+e,this}setBlur(e){return this.blur=+e+"px",this}setGrayScale(e){return this.grayScale=e,this}setStream(e){return this.stream=e,this}setBackgroundImage(e){return this.url=e,this.color=null,this}setBackgroundColor(e){return this.color=e,this}appendScriptToHead(e,{async:t=!0,defer:i=!1,callback:n=()=>{}}={}){try{let o;const r=this;function s(s){if(o)return s;const a=document.createElement("script");a.src=e,a.async=t,a.defer=i,a.onload=function(){try{return r.scriptLoaded=!0,Promise.resolve(n()).then(function(){})}catch(e){return Promise.reject(e)}},a.onerror=()=>console.error(`Failed to load script: ${e}`),document.head.appendChild(a)}const a=function(){if(r.scriptLoaded)return Promise.resolve(n()).then(function(){o=1})}();return Promise.resolve(a&&a.then?a.then(s):s(a))}catch(l){return Promise.reject(l)}}applyBackgroundImage(e){const t=this.ctx,{videoWidth:i,videoHeight:n}=this.videoInfo;t.filter=`brightness(${this.brightness}) contrast(${this.contrast}) blur(${this.blur})`,t.drawImage(e.segmentationMask,0,0,i,n),t.globalCompositeOperation="source-out",t.drawImage(this.getBackgroundImage()?this.getBackgroundImage():this.videoElement,0,0,i,n),t.globalCompositeOperation="destination-atop",t.filter=`brightness(${this.brightness}) contrast(${this.contrast})`,t.drawImage(e.image,0,0,i,n)}applyBrightnessAndContrast(){this.ctx.filter=`brightness(${this.brightness}) contrast(${this.contrast}) `}applyBackgroundColor(e){const t=this.ctx,{videoWidth:i,videoHeight:n}=this.videoInfo;t.drawImage(e.segmentationMask,0,0,i,n),t.globalCompositeOperation="source-out",t.fillStyle=this.color,t.fillRect(0,0,i,n),t.globalCompositeOperation="destination-atop",t.drawImage(e.image,0,0,i,n)}applyGrayscale(){const e=this.ctx,{videoWidth:t,videoHeight:i}=this.videoInfo,n=e.getImageData(0,0,t,i),o=n.data;for(let e=0;e<o.length;e+=4)o[e]=o[e+1]=o[e+2]=(o[e]+o[e+1]+o[e+2])/3;e.putImageData(n,0,0)}backgroundList(){return{color:[{value:"#F9C0AB",alt:"#F9C0AB"},{value:"#F4E0AF",alt:"#F4E0AF"},{value:"#A8CD89",alt:"#A8CD89"},{value:"#355F2E",alt:"#355F2E"}],image:[{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/1.jpg",alt:"Image 1"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/2.jpg",alt:"Image 2"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/3.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/4.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/5.webp",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/6.jpg",alt:"Image 113"},{value:"https://alireza5014.github.io/webrtc-bg-modifier/example/img/7.webp",alt:"Image 113"}]}}setupSegmentation(e){try{const e=this,t=e.getBackgroundImage();return Promise.resolve(e.appendScriptToHead("https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js",{async:!0,callback:function(){try{const i=function(){if(!e.segmentation){e.segmentation=new SelfieSegmentation({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${e}`});const i=/Mobi|Android/i.test(navigator.userAgent);e.videoElement.width=i?480:1280,e.videoElement.height=i?360:720,e.segmentation.setOptions({selfieMode:!1,modelSelection:i?0:1}),e.segmentation.onResults(i=>{e.color?(e.applyBackgroundColor(i),e.applyBrightnessAndContrast()):e.applyBackgroundImage(i,t),e.grayScale&&e.applyGrayscale()});let n=0;const o=function(){try{function t(){requestAnimationFrame(o)}const i=function(){if(e.processing){const t=performance.now(),i=function(){if(t-n>=1e3/e.fps)return n=t,Promise.resolve(e.segmentation.send({image:e.videoElement})).then(function(){})}();if(i&&i.then)return i.then(function(){})}}();return Promise.resolve(i&&i.then?i.then(t):t())}catch(r){return Promise.reject(r)}};return Promise.resolve(o()).then(function(){})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}})).then(function(){})}catch(e){return Promise.reject(e)}}changeBackground(){try{const e=this;function t(){return e.processing=!0,e.setBackgroundImage2(o),Promise.resolve(e.setupSegmentation()).then(function(){return e.canvasElement.captureStream(e.fps)})}e.videoElement.srcObject||(e.videoElement.srcObject=e.stream,e.videoElement.play(),e.videoElement.addEventListener("loadedmetadata",()=>{console.log({videoWidth:e.videoElement.videoWidth,videoHeight:e.videoElement.videoHeight},"jjjjjjjj"),e.videoInfo={videoWidth:e.videoElement.videoWidth,videoHeight:e.videoElement.videoHeight}}));const{videoWidth:i,videoHeight:n}=e.videoInfo;if(e.canvasElement.width=i,e.canvasElement.height=n,e.ctx=e.canvasElement.getContext("2d"),!(e.url||e.grayScale||1!==e.brightness||1!==e.contrast||e.color||e.blur))return e.processing=!1,Promise.resolve(e.stream);let o=null;const r=function(){if(e.url)return o=new Image,o.crossOrigin="anonymous",o.src=e.url,Promise.resolve(new Promise(e=>o.onload=e)).then(function(){})}();return Promise.resolve(r&&r.then?r.then(t):t())}catch(s){return Promise.reject(s)}}};
//# sourceMappingURL=index.js.map
